let s,a=0,v=null;function M(){return(v===null||v.byteLength===0)&&(v=new Uint8Array(s.memory.buffer)),v}const j=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},X=typeof j.encodeInto=="function"?function(t,e){return j.encodeInto(t,e)}:function(t,e){const n=j.encode(t);return e.set(n),{read:t.length,written:n.length}};function l(t,e,n){if(n===void 0){const _=j.encode(t),u=e(_.length,1)>>>0;return M().subarray(u,u+_.length).set(_),a=_.length,u}let r=t.length,o=e(r,1)>>>0;const c=M();let i=0;for(;i<r;i++){const _=t.charCodeAt(i);if(_>127)break;c[o+i]=_}if(i!==r){i!==0&&(t=t.slice(i)),o=n(o,r,r=i+t.length*3,1)>>>0;const _=M().subarray(o+i,o+r),u=X(t,_);i+=u.written,o=n(o,r,i,1)>>>0}return a=i,o}let x=null;function y(){return(x===null||x.buffer.detached===!0||x.buffer.detached===void 0&&x.buffer!==s.memory.buffer)&&(x=new DataView(s.memory.buffer)),x}function S(t){const e=s.__externref_table_alloc();return s.__wbindgen_export_4.set(e,t),e}function k(t,e){try{return t.apply(this,e)}catch(n){const r=S(n);s.__wbindgen_exn_store(r)}}const H=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&H.decode();function g(t,e){return t=t>>>0,H.decode(M().subarray(t,t+e))}function p(t){return t==null}const P=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>{s.__wbindgen_export_6.get(t.dtor)(t.a,t.b)});function Y(t,e,n,r){const o={a:t,b:e,cnt:1,dtor:n},c=(...i)=>{o.cnt++;const _=o.a;o.a=0;try{return r(_,o.b,...i)}finally{--o.cnt===0?(s.__wbindgen_export_6.get(o.dtor)(_,o.b),P.unregister(o)):o.a=_}};return c.original=o,P.register(c,o,o),c}function z(t){const e=typeof t;if(e=="number"||e=="boolean"||t==null)return`${t}`;if(e=="string")return`"${t}"`;if(e=="symbol"){const o=t.description;return o==null?"Symbol":`Symbol(${o})`}if(e=="function"){const o=t.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(t)){const o=t.length;let c="[";o>0&&(c+=z(t[0]));for(let i=1;i<o;i++)c+=", "+z(t[i]);return c+="]",c}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(n&&n.length>1)r=n[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function b(t){const e=s.__wbindgen_export_4.get(t);return s.__externref_table_dealloc(t),e}function Q(t,e){const n=s.extrude_geometry(t,e);if(n[2])throw b(n[1]);return b(n[0])}function ee(t){let e,n;try{const c=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),i=a,_=s.generate_3mf_model_xml(c,i);var r=_[0],o=_[1];if(_[3])throw r=0,o=0,b(_[2]);return e=r,n=o,g(r,o)}finally{s.__wbindgen_free(e,n,1)}}function te(){let t,e;try{const n=s.generate_3mf_content_types_xml();return t=n[0],e=n[1],g(n[0],n[1])}finally{s.__wbindgen_free(t,e,1)}}function ne(){let t,e;try{const n=s.generate_3mf_rels_xml();return t=n[0],e=n[1],g(n[0],n[1])}finally{s.__wbindgen_free(t,e,1)}}function re(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.register_group_js(e,n);if(r[1])throw b(r[0])}function oe(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.free_group_js(e,n);if(r[1])throw b(r[0])}function se(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.free_cache_by_id(e,n);if(r[1])throw b(r[0])}function ce(t){let e,n;try{const r=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),o=a,c=s.create_cancellation_token(r,o);return e=c[0],n=c[1],g(c[0],c[1])}finally{s.__wbindgen_free(e,n,1)}}function ie(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a;return s.cancel_operation(e,n)!==0}function _e(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a;return s.cleanup_cancellation_token(e,n)!==0}function ae(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a;return s.process_elevation_data_async(e,n)}function le(t){return s.create_terrain_geometry(t)}function fe(t){return s.extract_features_from_vector_tiles(t)}function ue(t){return s.fetch_vector_tiles(t)}function ge(){s.start()}function be(t,e){const n=e(t.length*1,1)>>>0;return M().set(t,n/1),a=t.length,n}function de(t,e,n,r,o,c,i){const _=l(r,s.__wbindgen_malloc,s.__wbindgen_realloc),u=a,W=be(i,s.__wbindgen_malloc),F=a;return s.store_raster_tile(t,e,n,_,u,o,c,W,F)!==0}function we(t,e,n,r){const o=l(r,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a;return s.has_raster_tile(t,e,n,o,c)!==0}function ye(){const t=s.get_cache_stats();if(t[2])throw b(t[1]);return b(t[0])}function pe(){return s.clear_caches()!==0}function me(t,e,n){const r=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),o=a,c=l(e,s.__wbindgen_malloc,s.__wbindgen_realloc),i=a;return s.add_process_feature_data_js(r,o,c,i,n)!==0}function he(t,e){const n=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),r=a,o=l(e,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a;return s.get_process_feature_data_js(n,r,o,c)}function xe(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a;return s.clear_process_cache_js(e,n)!==0}function We(){return s.get_cached_process_ids_js()}function ke(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.hello_from_rust(e,n);if(r[2])throw b(r[1]);return b(r[0])}function Ae(t,e){return s.add(t,e)}let E=null;function ve(){return(E===null||E.byteLength===0)&&(E=new Float64Array(s.memory.buffer)),E}function Se(t,e){const n=e(t.length*8,8)>>>0;return ve().set(t,n/8),a=t.length,n}function Ee(t,e){let n,r;try{const o=Se(t,s.__wbindgen_malloc),c=a,i=s.buffer_line_string_direct(o,c,e);return n=i[0],r=i[1],g(i[0],i[1])}finally{s.__wbindgen_free(n,r,1)}}function Me(t,e){let n,r;try{const o=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a,i=s.buffer_line_string(o,c,e);return n=i[0],r=i[1],g(i[0],i[1])}finally{s.__wbindgen_free(n,r,1)}}function Te(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.register_cache_group(e,n);if(r[1])throw b(r[0])}function Ie(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.free_cache_group(e,n);if(r[1])throw b(r[0])}function je(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.merge_geometries_with_csg_union(e,n);if(r[2])throw b(r[1]);return b(r[0])}function $e(t,e){let n,r;try{const o=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a,i=s.buffer_line_strings_batch(o,c,e);return n=i[0],r=i[1],g(i[0],i[1])}finally{s.__wbindgen_free(n,r,1)}}function Fe(){let t,e;try{const n=s.get_wasm_info();return t=n[0],e=n[1],g(n[0],n[1])}finally{s.__wbindgen_free(t,e,1)}}function ze(){let t,e;try{const n=s.test_initialization();return t=n[0],e=n[1],g(n[0],n[1])}finally{s.__wbindgen_free(t,e,1)}}function Oe(t){const e=l(t,s.__wbindgen_malloc,s.__wbindgen_realloc),n=a,r=s.process_polygon_geometry(e,n);if(r[2])throw b(r[1]);return b(r[0])}function De(t,e,n){s.closure145_externref_shim(t,e,n)}function Le(t,e,n,r){s.closure169_externref_shim(t,e,n,r)}const B=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_terrainsample_free(t>>>0,1));class Re{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,B.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_terrainsample_free(e,0)}constructor(e,n,r){const o=s.terrainsample_new(e,n,r);return this.__wbg_ptr=o>>>0,B.register(this,this.__wbg_ptr,this),this}get x(){return s.terrainsample_x(this.__wbg_ptr)}get y(){return s.terrainsample_y(this.__wbg_ptr)}get elevation(){return s.terrainsample_elevation(this.__wbg_ptr)}}async function Ue(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function G(){const t={};return t.wbg={},t.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,n){const r=String(n),o=l(r,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a;y().setInt32(e+4*1,c,!0),y().setInt32(e+4*0,o,!0)},t.wbg.__wbg_buffer_09165b52af8c5237=function(e){return e.buffer},t.wbg.__wbg_buffer_609cc3eee51ed158=function(e){return e.buffer},t.wbg.__wbg_byteOffset_fd862df290ef848d=function(e){return e.byteOffset},t.wbg.__wbg_call_672a4d21634d4a24=function(){return k(function(e,n){return e.call(n)},arguments)},t.wbg.__wbg_call_7cccdd69e0791ae2=function(){return k(function(e,n,r){return e.call(n,r)},arguments)},t.wbg.__wbg_constructor_9fd96f589d65d4e5=function(e){return e.constructor},t.wbg.__wbg_done_769e5ede4b31c67b=function(e){return e.done},t.wbg.__wbg_entries_3265d4158b33e5dc=function(e){return Object.entries(e)},t.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,n){let r,o;try{r=e,o=n,console.error(g(e,n))}finally{s.__wbindgen_free(r,o,1)}},t.wbg.__wbg_fetch_2282f39a161a1523=function(){return k(function(e,n){return wasmJsHelpers.fetch(g(e,n))},arguments)},t.wbg.__wbg_from_2a5d3e218e67aa85=function(e){return Array.from(e)},t.wbg.__wbg_getPrototypeOf_64af13611bceb86e=function(e){return Object.getPrototypeOf(e)},t.wbg.__wbg_get_67b2ba62fc30de12=function(){return k(function(e,n){return Reflect.get(e,n)},arguments)},t.wbg.__wbg_get_b9b93047fe3cf45b=function(e,n){return e[n>>>0]},t.wbg.__wbg_getwithrefkey_1dc361bd10053bfe=function(e,n){return e[n]},t.wbg.__wbg_instanceof_ArrayBuffer_e14585432e3737fc=function(e){let n;try{n=e instanceof ArrayBuffer}catch{n=!1}return n},t.wbg.__wbg_instanceof_Map_f3469ce2244d2430=function(e){let n;try{n=e instanceof Map}catch{n=!1}return n},t.wbg.__wbg_instanceof_Uint8Array_17156bcf118086a9=function(e){let n;try{n=e instanceof Uint8Array}catch{n=!1}return n},t.wbg.__wbg_isArray_a1eab7e0d067391b=function(e){return Array.isArray(e)},t.wbg.__wbg_isSafeInteger_343e2beeeece1bb0=function(e){return Number.isSafeInteger(e)},t.wbg.__wbg_iterator_9a24c88df860dc65=function(){return Symbol.iterator},t.wbg.__wbg_length_3b4f022188ae8db6=function(e){return e.length},t.wbg.__wbg_length_6ca527665d89694d=function(e){return e.length},t.wbg.__wbg_length_a446193dc22c12f8=function(e){return e.length},t.wbg.__wbg_length_e2d2a49132c1b256=function(e){return e.length},t.wbg.__wbg_log_c222819a41e063d3=function(e){console.log(e)},t.wbg.__wbg_log_eafd6eac89f36cd9=function(e,n){console.log(g(e,n))},t.wbg.__wbg_name_16617c8e9d4188ac=function(e){return e.name},t.wbg.__wbg_new_23a2665fac83c611=function(e,n){try{var r={a:e,b:n},o=(i,_)=>{const u=r.a;r.a=0;try{return Le(u,r.b,i,_)}finally{r.a=u}};return new Promise(o)}finally{r.a=r.b=0}},t.wbg.__wbg_new_405e22f390576ce2=function(){return new Object},t.wbg.__wbg_new_5e0be73521bc8c17=function(){return new Map},t.wbg.__wbg_new_780abee5c1739fd7=function(e){return new Float32Array(e)},t.wbg.__wbg_new_78feb108b6472713=function(){return new Array},t.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},t.wbg.__wbg_new_a12002a7f91c75be=function(e){return new Uint8Array(e)},t.wbg.__wbg_newnoargs_105ed471475aaf50=function(e,n){return new Function(g(e,n))},t.wbg.__wbg_newwithbyteoffsetandlength_d97e637ebe145a9a=function(e,n,r){return new Uint8Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithbyteoffsetandlength_e6b7e69acd4c7354=function(e,n,r){return new Float32Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithbyteoffsetandlength_f1dead44d1fc7212=function(e,n,r){return new Uint32Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithlength_5a5efe313cfd59f1=function(e){return new Float32Array(e>>>0)},t.wbg.__wbg_newwithlength_bd3de93688d68fbc=function(e){return new Uint32Array(e>>>0)},t.wbg.__wbg_newwithlength_c4c419ef0bc8a1f8=function(e){return new Array(e>>>0)},t.wbg.__wbg_next_25feadfc0913fea9=function(e){return e.next},t.wbg.__wbg_next_6574e1a8a62d1055=function(){return k(function(e){return e.next()},arguments)},t.wbg.__wbg_now_807e54c39636c349=function(){return Date.now()},t.wbg.__wbg_queueMicrotask_97d92b4fcc8a61c5=function(e){queueMicrotask(e)},t.wbg.__wbg_queueMicrotask_d3219def82552485=function(e){return e.queueMicrotask},t.wbg.__wbg_resolve_4851785c9c5f573d=function(e){return Promise.resolve(e)},t.wbg.__wbg_set_10bad9bee0e9c58b=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_set_37837023f3d740e8=function(e,n,r){e[n>>>0]=r},t.wbg.__wbg_set_3f1d0b984ed272ed=function(e,n,r){e[n]=r},t.wbg.__wbg_set_65595bdd868b3009=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_set_8fc6bf8a5b1071d1=function(e,n,r){return e.set(n,r)},t.wbg.__wbg_set_bb8cecf6a62b9f46=function(){return k(function(e,n,r){return Reflect.set(e,n,r)},arguments)},t.wbg.__wbg_set_d23661d19148b229=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,n){const r=n.stack,o=l(r,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a;y().setInt32(e+4*1,c,!0),y().setInt32(e+4*0,o,!0)},t.wbg.__wbg_static_accessor_GLOBAL_88a902d13a557d07=function(){const e=typeof global>"u"?null:global;return p(e)?0:S(e)},t.wbg.__wbg_static_accessor_GLOBAL_THIS_56578be7e9f832b0=function(){const e=typeof globalThis>"u"?null:globalThis;return p(e)?0:S(e)},t.wbg.__wbg_static_accessor_SELF_37c5d418e4bf5819=function(){const e=typeof self>"u"?null:self;return p(e)?0:S(e)},t.wbg.__wbg_static_accessor_WINDOW_5de37043a91a9c40=function(){const e=typeof window>"u"?null:window;return p(e)?0:S(e)},t.wbg.__wbg_then_44b73946d2fb3e7d=function(e,n){return e.then(n)},t.wbg.__wbg_then_48b406749878a531=function(e,n,r){return e.then(n,r)},t.wbg.__wbg_value_cd1ffa7b1ab794f1=function(e){return e.value},t.wbg.__wbindgen_as_number=function(e){return+e},t.wbg.__wbindgen_bigint_from_i64=function(e){return e},t.wbg.__wbindgen_bigint_from_u64=function(e){return BigInt.asUintN(64,e)},t.wbg.__wbindgen_bigint_get_as_i64=function(e,n){const r=n,o=typeof r=="bigint"?r:void 0;y().setBigInt64(e+8*1,p(o)?BigInt(0):o,!0),y().setInt32(e+4*0,!p(o),!0)},t.wbg.__wbindgen_boolean_get=function(e){const n=e;return typeof n=="boolean"?n?1:0:2},t.wbg.__wbindgen_cb_drop=function(e){const n=e.original;return n.cnt--==1?(n.a=0,!0):!1},t.wbg.__wbindgen_closure_wrapper1014=function(e,n,r){return Y(e,n,146,De)},t.wbg.__wbindgen_debug_string=function(e,n){const r=z(n),o=l(r,s.__wbindgen_malloc,s.__wbindgen_realloc),c=a;y().setInt32(e+4*1,c,!0),y().setInt32(e+4*0,o,!0)},t.wbg.__wbindgen_error_new=function(e,n){return new Error(g(e,n))},t.wbg.__wbindgen_in=function(e,n){return e in n},t.wbg.__wbindgen_init_externref_table=function(){const e=s.__wbindgen_export_4,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t.wbg.__wbindgen_is_bigint=function(e){return typeof e=="bigint"},t.wbg.__wbindgen_is_function=function(e){return typeof e=="function"},t.wbg.__wbindgen_is_null=function(e){return e===null},t.wbg.__wbindgen_is_object=function(e){const n=e;return typeof n=="object"&&n!==null},t.wbg.__wbindgen_is_string=function(e){return typeof e=="string"},t.wbg.__wbindgen_is_undefined=function(e){return e===void 0},t.wbg.__wbindgen_jsval_eq=function(e,n){return e===n},t.wbg.__wbindgen_jsval_loose_eq=function(e,n){return e==n},t.wbg.__wbindgen_memory=function(){return s.memory},t.wbg.__wbindgen_number_get=function(e,n){const r=n,o=typeof r=="number"?r:void 0;y().setFloat64(e+8*1,p(o)?0:o,!0),y().setInt32(e+4*0,!p(o),!0)},t.wbg.__wbindgen_number_new=function(e){return e},t.wbg.__wbindgen_string_get=function(e,n){const r=n,o=typeof r=="string"?r:void 0;var c=p(o)?0:l(o,s.__wbindgen_malloc,s.__wbindgen_realloc),i=a;y().setInt32(e+4*1,i,!0),y().setInt32(e+4*0,c,!0)},t.wbg.__wbindgen_string_new=function(e,n){return g(e,n)},t.wbg.__wbindgen_throw=function(e,n){throw new Error(g(e,n))},t}function K(t,e){return s=t.exports,O.__wbindgen_wasm_module=e,x=null,E=null,v=null,s.__wbindgen_start(),s}function Ne(t){if(s!==void 0)return s;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module:t}=t:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const e=G();t instanceof WebAssembly.Module||(t=new WebAssembly.Module(t));const n=new WebAssembly.Instance(t,e);return K(n,t)}async function O(t){if(s!==void 0)return s;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL(""+new URL("threegis_core_wasm_bg-DagZO7n3.wasm",import.meta.url).href,import.meta.url));const e=G();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await Ue(await t,e);return K(n,r)}var Ce=Object.freeze({__proto__:null,TerrainSample:Re,add:Ae,add_process_feature_data_js:me,buffer_line_string:Me,buffer_line_string_direct:Ee,buffer_line_strings_batch:$e,cancel_operation:ie,cleanup_cancellation_token:_e,clear_caches:pe,clear_process_cache_js:xe,create_cancellation_token:ce,create_terrain_geometry:le,default:O,extract_features_from_vector_tiles:fe,extrude_geometry:Q,fetch_vector_tiles:ue,free_cache_by_id:se,free_cache_group:Ie,free_group_js:oe,generate_3mf_content_types_xml:te,generate_3mf_model_xml:ee,generate_3mf_rels_xml:ne,get_cache_stats:ye,get_cached_process_ids_js:We,get_process_feature_data_js:he,get_wasm_info:Fe,has_raster_tile:we,hello_from_rust:ke,initSync:Ne,merge_geometries_with_csg_union:je,process_elevation_data_async:ae,process_polygon_geometry:Oe,register_cache_group:Te,register_group_js:re,start:ge,store_raster_tile:de,test_initialization:ze});const Pe=t=>{const e=t.split("/");let n=0,r=0,o=0;if(e.length>=3){const c=parseInt(e[e.length-3],10),i=parseInt(e[e.length-2],10),_=parseInt(e[e.length-1],10);if(isNaN(c)||(o=c),isNaN(i)||(n=i),!isNaN(_)){const u=e[e.length-1],W=u.indexOf(".");W>0?r=parseInt(u.substring(0,W),10):r=_}}return{x:n,y:r,z:o}},Be=async(t,e)=>{const n=new AbortController,r=setTimeout(()=>n.abort(),e);try{const o=await fetch(t,{signal:n.signal});return clearTimeout(r),o}catch(o){throw clearTimeout(r),o instanceof Error&&o.name==="AbortError"?new Error(`Request timeout after ${e}ms`):o}},q=async(t,e)=>{let n;for(let r=0;r<=e.maxRetries;r++)try{const o=await Be(t,e.timeoutMs);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const c=o.headers.get("content-type")||"application/octet-stream",i=await o.arrayBuffer(),_=new Uint8Array(i);if(e.validateContent&&_.length===0)throw new Error("Empty response data");const u=Pe(t);return{width:256,height:256,x:u.x,y:u.y,z:u.z,rawData:_,mimeType:c}}catch(o){if(n=o instanceof Error?o:new Error(String(o)),r<e.maxRetries){const c=e.backoffMs*Math.pow(2,r);await new Promise(i=>setTimeout(i,c));continue}}throw new Error(`Fetch failed after ${e.maxRetries+1} attempts: ${n.message}`)},qe=()=>{const t={maxRetries:3,timeoutMs:1e4,backoffMs:1e3,validateContent:!0};self.wasmJsHelpers={...self.wasmJsHelpers,fetch:async(e,n)=>{const r={...t,...n};return q(e,r)},fetchWithConfig:async(e,n)=>q(e,n)}};let f=null,T=!1,w=null,h=!1,$=new Map,J=null,D=null;async function Je(){try{if(console.log("[Worker] Initializing WASM module..."),qe(),console.log("[Worker] WASM fetch helpers initialized"),!WebAssembly)throw new Error("WebAssembly not supported in worker environment");const t=new WebAssembly.Memory({initial:1024,maximum:8192}),e=new WebAssembly.Table({initial:5e3,maximum:25e3,element:"anyfunc"}),n=new WebAssembly.Table({initial:5e3,maximum:25e3,element:"externref"});self.__WASM_MEMORY=t,self.__WASM_TABLE=e,self.__WASM_EXTERNREF_TABLE=n,self.__wbindgen_externref_table_ptr=n,self.__wbindgen_anyfunc_table_ptr=e,await O(),f=Ce;const o=["extract_features_from_vector_tiles","process_polygon_geometry"].filter(c=>!f[c]||typeof f[c]!="function");if(o.length>0)throw new Error(`Missing WASM functions: ${o.join(", ")}`);T=!0,console.log("[Worker] WASM module initialized successfully")}catch(t){throw T=!1,f=null,new Error(`Worker WASM initialization failed: ${t}`)}}async function He(t){try{console.log(`[Worker] Syncing shared resources for process: ${t.processId}`),D=t.processId,$.clear(),J=null;for(const e of t.vectorTiles)$.set(e.tileKey,e);t.elevationData&&(J=t.elevationData),T&&f&&await Ge(t),console.log(`[Worker] Successfully synced ${t.vectorTiles.length} vector tiles`)}catch(e){throw console.error("[Worker] Failed to sync shared resources:",e),e}}async function Ge(t){if(!f)throw new Error("WASM module not available");try{if(f.add_process_feature_data_js&&t.vectorTiles.length>0){console.log(`[Worker] Loading ${t.vectorTiles.length} vector tiles into WASM process cache`);const e=t.vectorTiles.map(r=>({tileKey:r.tileKey,x:r.metadata.x,y:r.metadata.y,z:r.metadata.z,sourceLayer:r.metadata.sourceLayer,data:Array.from(new Uint8Array(r.data)),size:r.metadata.size})),n=["vector_tiles","vt_data","tile_cache"];for(const r of n)try{f.add_process_feature_data_js(t.processId,r,JSON.stringify(e))&&console.log(`[Worker] ✅ Successfully stored vector tiles under key: ${r}`)}catch(o){console.warn(`[Worker] Failed to store tiles under key ${r}:`,o)}for(const r of t.vectorTiles)try{const o={x:r.metadata.x,y:r.metadata.y,z:r.metadata.z,sourceLayer:r.metadata.sourceLayer,data:Array.from(new Uint8Array(r.data)),size:r.metadata.size};f.add_process_feature_data_js(t.processId,`tile_${r.tileKey}`,JSON.stringify(o))}catch(o){console.warn(`[Worker] Failed to store individual tile ${r.tileKey}:`,o)}}if(t.elevationData&&f.add_process_feature_data_js)try{f.add_process_feature_data_js(t.processId,"elevation_data",JSON.stringify(t.elevationData))&&console.log("[Worker] ✅ Successfully stored elevation data")}catch(e){console.warn("[Worker] Failed to store elevation data:",e)}console.log(`[Worker] Successfully loaded resources into WASM instance for process ${t.processId}`)}catch(e){console.warn("[Worker] Warning: Could not load resources into WASM:",e)}}async function Ke(t,e){if(!f)throw new Error("WASM module not available");try{if($.size>0){console.log(`[Worker] Using ${$.size} shared vector tiles for process ${t}`);return}if(f.get_cached_process_ids_js){const u=f.get_cached_process_ids_js();if(u&&u.includes(t)){console.log(`[Worker] Vector tiles already available in WASM cache for process ${t}`);return}}const n=`${t}_worker_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;console.log(`[Worker] Fetching vector tiles directly with worker process ID: ${n}`);const[r,o,c,i]=e,_={min_lng:r,min_lat:o,max_lng:c,max_lat:i,zoom:14,grid_width:256,grid_height:256,process_id:n};f.fetch_vector_tiles?(await f.fetch_vector_tiles(_),console.log(`[Worker] ✅ Successfully fetched vector tiles for worker process ${n}`),D=n):console.warn("[Worker] fetch_vector_tiles function not available")}catch(n){console.warn(`[Worker] Warning: Could not ensure vector tiles for process ${t}:`,n)}}async function Ve(t){if(!T||!f)throw new Error("WASM module not initialized in worker");const{layerConfig:e,bboxCoords:n,processId:r,terrainData:o,terrainSettings:c,debugMode:i}=t;try{if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:5,data:{message:`Ensuring vector tiles for ${e.sourceLayer}...`}}),await Ke(r,n),postMessage({id:w,type:"progress",progress:10,data:{message:`Extracting features for ${e.sourceLayer}...`}});const _=D||r,u=await f.extract_features_from_vector_tiles({bbox:n,vtDataSet:e,processId:_,elevationProcessId:_});if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:40,data:{message:`Creating geometry for ${e.sourceLayer}...`}});const W={terrainBaseHeight:c.baseHeight,verticalExaggeration:c.verticalExaggeration,bbox:n,elevationGrid:o.processedElevationGrid,gridSize:o.gridSize,minElevation:o.originalMinElevation,maxElevation:o.originalMaxElevation,vtDataSet:{...e,geometryDebugMode:i},useSameZOffset:!0,processId:_};if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:60,data:{message:`Processing ${e.sourceLayer} geometry...`}});const F=JSON.stringify(W),L=await f.process_polygon_geometry(F);if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:80,data:{message:`Parsing geometry data for ${e.sourceLayer}...`}});let I;try{I=JSON.parse(L)}catch(m){throw new Error(`Failed to parse geometry JSON: ${m}`)}if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:90,data:{message:`Optimizing geometry for ${e.sourceLayer}...`}});const A=[],Ze=I.length;for(let m=0;m<I.length;m++){if(h)throw new Error("Task was cancelled");const d=I[m];if(!d.hasData||!d.vertices||d.vertices.length===0){A.push({hasData:!1,vertices:[],indices:[],normals:[],colors:[],properties:d.properties||{}});continue}const V=new Float32Array(d.vertices);let R=null;d.indices&&d.indices.length>0&&(R=new Uint32Array(d.indices));let U=null,N=!1;d.normals&&d.normals.length>0?U=new Float32Array(d.normals):N=!0;let C=null;d.colors&&d.colors.length>0&&(C=new Float32Array(d.colors)),A.push({hasData:!0,vertices:V,indices:R,normals:U,colors:C,needsNormals:N,properties:d.properties||{}}),m%10===0&&await new Promise(Z=>setTimeout(Z,0))}return postMessage({id:w,type:"progress",progress:100,data:{message:`${e.sourceLayer} processing complete`}}),{layerConfig:e,geometries:A,totalProcessed:A.length,hasData:A.some(m=>m.hasData)}}catch(_){throw console.error("[Worker] Layer processing failed:",_),_}}self.onmessage=async t=>{const{id:e,type:n,data:r}=t.data;try{switch(n){case"init":await Je(),postMessage({id:e,type:"initialized",data:{success:!0}});break;case"process-layer":w=e,h=!1;const o=await Ve(r);postMessage({id:e,type:"result",data:o}),w=null;break;case"sync-resources":await He(r),postMessage({id:e,type:"resources-synced",success:!0,processId:r.processId});break;case"cancel":(w===e||!e)&&(h=!0,console.log(`[Worker] Cancelling task: ${w||"all"}`));break;case"terminate":if(f&&f.clear_process_cache_js)try{f.clear_process_cache_js()}catch(c){console.warn("[Worker] Cleanup error:",c)}f=null,T=!1,self.close();break;default:throw new Error(`Unknown message type: ${n}`)}}catch(o){console.error("[Worker] Error handling message:",o),postMessage({id:e,type:"error",error:o instanceof Error?o.message:String(o)})}};self.onerror=t=>{console.error("[Worker] Unhandled error:",t),w&&postMessage({id:w,type:"error",error:`Worker error: ${t.message||t}`})};
