let o,a=0,v=null;function M(){return(v===null||v.byteLength===0)&&(v=new Uint8Array(o.memory.buffer)),v}const I=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Y=typeof I.encodeInto=="function"?function(t,e){return I.encodeInto(t,e)}:function(t,e){const n=I.encode(t);return e.set(n),{read:t.length,written:n.length}};function l(t,e,n){if(n===void 0){const i=I.encode(t),u=e(i.length,1)>>>0;return M().subarray(u,u+i.length).set(i),a=i.length,u}let r=t.length,s=e(r,1)>>>0;const c=M();let _=0;for(;_<r;_++){const i=t.charCodeAt(_);if(i>127)break;c[s+_]=i}if(_!==r){_!==0&&(t=t.slice(_)),s=n(s,r,r=_+t.length*3,1)>>>0;const i=M().subarray(s+_,s+r),u=Y(t,i);_+=u.written,s=n(s,r,_,1)>>>0}return a=_,s}let x=null;function y(){return(x===null||x.buffer.detached===!0||x.buffer.detached===void 0&&x.buffer!==o.memory.buffer)&&(x=new DataView(o.memory.buffer)),x}function S(t){const e=o.__externref_table_alloc();return o.__wbindgen_export_4.set(e,t),e}function k(t,e){try{return t.apply(this,e)}catch(n){const r=S(n);o.__wbindgen_exn_store(r)}}const H=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&H.decode();function g(t,e){return t=t>>>0,H.decode(M().subarray(t,t+e))}function p(t){return t==null}const P=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>{o.__wbindgen_export_6.get(t.dtor)(t.a,t.b)});function Z(t,e,n,r){const s={a:t,b:e,cnt:1,dtor:n},c=(..._)=>{s.cnt++;const i=s.a;s.a=0;try{return r(i,s.b,..._)}finally{--s.cnt===0?(o.__wbindgen_export_6.get(s.dtor)(i,s.b),P.unregister(s)):s.a=i}};return c.original=s,P.register(c,s,s),c}function z(t){const e=typeof t;if(e=="number"||e=="boolean"||t==null)return`${t}`;if(e=="string")return`"${t}"`;if(e=="symbol"){const s=t.description;return s==null?"Symbol":`Symbol(${s})`}if(e=="function"){const s=t.name;return typeof s=="string"&&s.length>0?`Function(${s})`:"Function"}if(Array.isArray(t)){const s=t.length;let c="[";s>0&&(c+=z(t[0]));for(let _=1;_<s;_++)c+=", "+z(t[_]);return c+="]",c}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(n&&n.length>1)r=n[1];else return toString.call(t);if(r=="Object")try{return"Object("+JSON.stringify(t)+")"}catch{return"Object"}return t instanceof Error?`${t.name}: ${t.message}
${t.stack}`:r}function d(t){const e=o.__wbindgen_export_4.get(t);return o.__externref_table_dealloc(t),e}function Q(t,e){const n=o.extrude_geometry(t,e);if(n[2])throw d(n[1]);return d(n[0])}function ee(t){let e,n;try{const c=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),_=a,i=o.generate_3mf_model_xml(c,_);var r=i[0],s=i[1];if(i[3])throw r=0,s=0,d(i[2]);return e=r,n=s,g(r,s)}finally{o.__wbindgen_free(e,n,1)}}function te(){let t,e;try{const n=o.generate_3mf_content_types_xml();return t=n[0],e=n[1],g(n[0],n[1])}finally{o.__wbindgen_free(t,e,1)}}function ne(){let t,e;try{const n=o.generate_3mf_rels_xml();return t=n[0],e=n[1],g(n[0],n[1])}finally{o.__wbindgen_free(t,e,1)}}function re(t){return o.create_terrain_geometry(t)}function oe(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a;return o.process_elevation_data_async(e,n)}function se(t){return o.extract_features_from_vector_tiles(t)}function ce(t){return o.fetch_vector_tiles(t)}function _e(){o.start()}function ie(t,e){const n=e(t.length*1,1)>>>0;return M().set(t,n/1),a=t.length,n}function ae(t,e,n,r,s,c,_){const i=l(r,o.__wbindgen_malloc,o.__wbindgen_realloc),u=a,W=ie(_,o.__wbindgen_malloc),F=a;return o.store_raster_tile(t,e,n,i,u,s,c,W,F)!==0}function le(t,e,n,r){const s=l(r,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a;return o.has_raster_tile(t,e,n,s,c)!==0}function fe(){const t=o.get_cache_stats();if(t[2])throw d(t[1]);return d(t[0])}function ue(){return o.clear_caches()!==0}function ge(t,e,n){const r=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),s=a,c=l(e,o.__wbindgen_malloc,o.__wbindgen_realloc),_=a;return o.add_feature_data_js(r,s,c,_,n)!==0}function de(t,e){const n=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),r=a,s=l(e,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a;return o.get_feature_data_js(n,r,s,c)}function be(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a;return o.clear_feature_data_for_bbox_js(e,n)!==0}function we(t,e,n){const r=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),s=a,c=l(e,o.__wbindgen_malloc,o.__wbindgen_realloc),_=a;return o.add_process_feature_data_js(r,s,c,_,n)!==0}function ye(t,e){const n=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),r=a,s=l(e,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a;return o.get_process_feature_data_js(n,r,s,c)}function pe(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a;return o.clear_process_cache_js(e,n)!==0}function me(){return o.get_cached_process_ids_js()}function he(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.hello_from_rust(e,n);if(r[2])throw d(r[1]);return d(r[0])}function xe(t,e){return o.add(t,e)}let E=null;function We(){return(E===null||E.byteLength===0)&&(E=new Float64Array(o.memory.buffer)),E}function ke(t,e){const n=e(t.length*8,8)>>>0;return We().set(t,n/8),a=t.length,n}function Ae(t,e){let n,r;try{const s=ke(t,o.__wbindgen_malloc),c=a,_=o.buffer_line_string_direct(s,c,e);return n=_[0],r=_[1],g(_[0],_[1])}finally{o.__wbindgen_free(n,r,1)}}function ve(t,e){let n,r;try{const s=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a,_=o.buffer_line_string(s,c,e);return n=_[0],r=_[1],g(_[0],_[1])}finally{o.__wbindgen_free(n,r,1)}}function Se(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.register_cache_group(e,n);if(r[1])throw d(r[0])}function Ee(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.free_cache_group(e,n);if(r[1])throw d(r[0])}function Me(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.merge_geometries_with_csg_union(e,n);if(r[2])throw d(r[1]);return d(r[0])}function je(t,e){let n,r;try{const s=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a,_=o.buffer_line_strings_batch(s,c,e);return n=_[0],r=_[1],g(_[0],_[1])}finally{o.__wbindgen_free(n,r,1)}}function Te(){let t,e;try{const n=o.get_wasm_info();return t=n[0],e=n[1],g(n[0],n[1])}finally{o.__wbindgen_free(t,e,1)}}function Ie(){let t,e;try{const n=o.test_initialization();return t=n[0],e=n[1],g(n[0],n[1])}finally{o.__wbindgen_free(t,e,1)}}function $e(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.process_polygon_geometry(e,n);if(r[2])throw d(r[1]);return d(r[0])}function Fe(t){let e,n;try{const r=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),s=a,c=o.create_cancellation_token(r,s);return e=c[0],n=c[1],g(c[0],c[1])}finally{o.__wbindgen_free(e,n,1)}}function ze(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a;return o.cancel_operation(e,n)!==0}function Oe(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a;return o.cleanup_cancellation_token(e,n)!==0}function De(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.register_group_js(e,n);if(r[1])throw d(r[0])}function Le(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.free_group_js(e,n);if(r[1])throw d(r[0])}function Re(t){const e=l(t,o.__wbindgen_malloc,o.__wbindgen_realloc),n=a,r=o.free_cache_by_id(e,n);if(r[1])throw d(r[0])}function Ue(t,e,n){o.closure146_externref_shim(t,e,n)}function Ne(t,e,n,r){o.closure170_externref_shim(t,e,n,r)}const B=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>o.__wbg_terrainsample_free(t>>>0,1));class Ce{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,B.unregister(this),e}free(){const e=this.__destroy_into_raw();o.__wbg_terrainsample_free(e,0)}constructor(e,n,r){const s=o.terrainsample_new(e,n,r);return this.__wbg_ptr=s>>>0,B.register(this,this.__wbg_ptr,this),this}get x(){return o.terrainsample_x(this.__wbg_ptr)}get y(){return o.terrainsample_y(this.__wbg_ptr)}get elevation(){return o.terrainsample_elevation(this.__wbg_ptr)}}async function Pe(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function G(){const t={};return t.wbg={},t.wbg.__wbg_String_8f0eb39a4a4c2f66=function(e,n){const r=String(n),s=l(r,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a;y().setInt32(e+4*1,c,!0),y().setInt32(e+4*0,s,!0)},t.wbg.__wbg_buffer_09165b52af8c5237=function(e){return e.buffer},t.wbg.__wbg_buffer_609cc3eee51ed158=function(e){return e.buffer},t.wbg.__wbg_byteOffset_fd862df290ef848d=function(e){return e.byteOffset},t.wbg.__wbg_call_672a4d21634d4a24=function(){return k(function(e,n){return e.call(n)},arguments)},t.wbg.__wbg_call_7cccdd69e0791ae2=function(){return k(function(e,n,r){return e.call(n,r)},arguments)},t.wbg.__wbg_constructor_9fd96f589d65d4e5=function(e){return e.constructor},t.wbg.__wbg_done_769e5ede4b31c67b=function(e){return e.done},t.wbg.__wbg_entries_3265d4158b33e5dc=function(e){return Object.entries(e)},t.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,n){let r,s;try{r=e,s=n,console.error(g(e,n))}finally{o.__wbindgen_free(r,s,1)}},t.wbg.__wbg_fetch_2282f39a161a1523=function(){return k(function(e,n){return wasmJsHelpers.fetch(g(e,n))},arguments)},t.wbg.__wbg_from_2a5d3e218e67aa85=function(e){return Array.from(e)},t.wbg.__wbg_getPrototypeOf_64af13611bceb86e=function(e){return Object.getPrototypeOf(e)},t.wbg.__wbg_get_67b2ba62fc30de12=function(){return k(function(e,n){return Reflect.get(e,n)},arguments)},t.wbg.__wbg_get_b9b93047fe3cf45b=function(e,n){return e[n>>>0]},t.wbg.__wbg_getwithrefkey_1dc361bd10053bfe=function(e,n){return e[n]},t.wbg.__wbg_instanceof_ArrayBuffer_e14585432e3737fc=function(e){let n;try{n=e instanceof ArrayBuffer}catch{n=!1}return n},t.wbg.__wbg_instanceof_Map_f3469ce2244d2430=function(e){let n;try{n=e instanceof Map}catch{n=!1}return n},t.wbg.__wbg_instanceof_Uint8Array_17156bcf118086a9=function(e){let n;try{n=e instanceof Uint8Array}catch{n=!1}return n},t.wbg.__wbg_isArray_a1eab7e0d067391b=function(e){return Array.isArray(e)},t.wbg.__wbg_isSafeInteger_343e2beeeece1bb0=function(e){return Number.isSafeInteger(e)},t.wbg.__wbg_iterator_9a24c88df860dc65=function(){return Symbol.iterator},t.wbg.__wbg_length_3b4f022188ae8db6=function(e){return e.length},t.wbg.__wbg_length_6ca527665d89694d=function(e){return e.length},t.wbg.__wbg_length_a446193dc22c12f8=function(e){return e.length},t.wbg.__wbg_length_e2d2a49132c1b256=function(e){return e.length},t.wbg.__wbg_log_c222819a41e063d3=function(e){console.log(e)},t.wbg.__wbg_log_eafd6eac89f36cd9=function(e,n){console.log(g(e,n))},t.wbg.__wbg_name_16617c8e9d4188ac=function(e){return e.name},t.wbg.__wbg_new_23a2665fac83c611=function(e,n){try{var r={a:e,b:n},s=(_,i)=>{const u=r.a;r.a=0;try{return Ne(u,r.b,_,i)}finally{r.a=u}};return new Promise(s)}finally{r.a=r.b=0}},t.wbg.__wbg_new_405e22f390576ce2=function(){return new Object},t.wbg.__wbg_new_5e0be73521bc8c17=function(){return new Map},t.wbg.__wbg_new_780abee5c1739fd7=function(e){return new Float32Array(e)},t.wbg.__wbg_new_78feb108b6472713=function(){return new Array},t.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},t.wbg.__wbg_new_a12002a7f91c75be=function(e){return new Uint8Array(e)},t.wbg.__wbg_newnoargs_105ed471475aaf50=function(e,n){return new Function(g(e,n))},t.wbg.__wbg_newwithbyteoffsetandlength_d97e637ebe145a9a=function(e,n,r){return new Uint8Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithbyteoffsetandlength_e6b7e69acd4c7354=function(e,n,r){return new Float32Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithbyteoffsetandlength_f1dead44d1fc7212=function(e,n,r){return new Uint32Array(e,n>>>0,r>>>0)},t.wbg.__wbg_newwithlength_5a5efe313cfd59f1=function(e){return new Float32Array(e>>>0)},t.wbg.__wbg_newwithlength_bd3de93688d68fbc=function(e){return new Uint32Array(e>>>0)},t.wbg.__wbg_newwithlength_c4c419ef0bc8a1f8=function(e){return new Array(e>>>0)},t.wbg.__wbg_next_25feadfc0913fea9=function(e){return e.next},t.wbg.__wbg_next_6574e1a8a62d1055=function(){return k(function(e){return e.next()},arguments)},t.wbg.__wbg_now_807e54c39636c349=function(){return Date.now()},t.wbg.__wbg_queueMicrotask_97d92b4fcc8a61c5=function(e){queueMicrotask(e)},t.wbg.__wbg_queueMicrotask_d3219def82552485=function(e){return e.queueMicrotask},t.wbg.__wbg_resolve_4851785c9c5f573d=function(e){return Promise.resolve(e)},t.wbg.__wbg_set_10bad9bee0e9c58b=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_set_37837023f3d740e8=function(e,n,r){e[n>>>0]=r},t.wbg.__wbg_set_3f1d0b984ed272ed=function(e,n,r){e[n]=r},t.wbg.__wbg_set_65595bdd868b3009=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_set_8fc6bf8a5b1071d1=function(e,n,r){return e.set(n,r)},t.wbg.__wbg_set_bb8cecf6a62b9f46=function(){return k(function(e,n,r){return Reflect.set(e,n,r)},arguments)},t.wbg.__wbg_set_d23661d19148b229=function(e,n,r){e.set(n,r>>>0)},t.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,n){const r=n.stack,s=l(r,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a;y().setInt32(e+4*1,c,!0),y().setInt32(e+4*0,s,!0)},t.wbg.__wbg_static_accessor_GLOBAL_88a902d13a557d07=function(){const e=typeof global>"u"?null:global;return p(e)?0:S(e)},t.wbg.__wbg_static_accessor_GLOBAL_THIS_56578be7e9f832b0=function(){const e=typeof globalThis>"u"?null:globalThis;return p(e)?0:S(e)},t.wbg.__wbg_static_accessor_SELF_37c5d418e4bf5819=function(){const e=typeof self>"u"?null:self;return p(e)?0:S(e)},t.wbg.__wbg_static_accessor_WINDOW_5de37043a91a9c40=function(){const e=typeof window>"u"?null:window;return p(e)?0:S(e)},t.wbg.__wbg_then_44b73946d2fb3e7d=function(e,n){return e.then(n)},t.wbg.__wbg_then_48b406749878a531=function(e,n,r){return e.then(n,r)},t.wbg.__wbg_value_cd1ffa7b1ab794f1=function(e){return e.value},t.wbg.__wbindgen_as_number=function(e){return+e},t.wbg.__wbindgen_bigint_from_i64=function(e){return e},t.wbg.__wbindgen_bigint_from_u64=function(e){return BigInt.asUintN(64,e)},t.wbg.__wbindgen_bigint_get_as_i64=function(e,n){const r=n,s=typeof r=="bigint"?r:void 0;y().setBigInt64(e+8*1,p(s)?BigInt(0):s,!0),y().setInt32(e+4*0,!p(s),!0)},t.wbg.__wbindgen_boolean_get=function(e){const n=e;return typeof n=="boolean"?n?1:0:2},t.wbg.__wbindgen_cb_drop=function(e){const n=e.original;return n.cnt--==1?(n.a=0,!0):!1},t.wbg.__wbindgen_closure_wrapper1029=function(e,n,r){return Z(e,n,147,Ue)},t.wbg.__wbindgen_debug_string=function(e,n){const r=z(n),s=l(r,o.__wbindgen_malloc,o.__wbindgen_realloc),c=a;y().setInt32(e+4*1,c,!0),y().setInt32(e+4*0,s,!0)},t.wbg.__wbindgen_error_new=function(e,n){return new Error(g(e,n))},t.wbg.__wbindgen_in=function(e,n){return e in n},t.wbg.__wbindgen_init_externref_table=function(){const e=o.__wbindgen_export_4,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t.wbg.__wbindgen_is_bigint=function(e){return typeof e=="bigint"},t.wbg.__wbindgen_is_function=function(e){return typeof e=="function"},t.wbg.__wbindgen_is_null=function(e){return e===null},t.wbg.__wbindgen_is_object=function(e){const n=e;return typeof n=="object"&&n!==null},t.wbg.__wbindgen_is_string=function(e){return typeof e=="string"},t.wbg.__wbindgen_is_undefined=function(e){return e===void 0},t.wbg.__wbindgen_jsval_eq=function(e,n){return e===n},t.wbg.__wbindgen_jsval_loose_eq=function(e,n){return e==n},t.wbg.__wbindgen_memory=function(){return o.memory},t.wbg.__wbindgen_number_get=function(e,n){const r=n,s=typeof r=="number"?r:void 0;y().setFloat64(e+8*1,p(s)?0:s,!0),y().setInt32(e+4*0,!p(s),!0)},t.wbg.__wbindgen_number_new=function(e){return e},t.wbg.__wbindgen_string_get=function(e,n){const r=n,s=typeof r=="string"?r:void 0;var c=p(s)?0:l(s,o.__wbindgen_malloc,o.__wbindgen_realloc),_=a;y().setInt32(e+4*1,_,!0),y().setInt32(e+4*0,c,!0)},t.wbg.__wbindgen_string_new=function(e,n){return g(e,n)},t.wbg.__wbindgen_throw=function(e,n){throw new Error(g(e,n))},t}function K(t,e){return o=t.exports,O.__wbindgen_wasm_module=e,x=null,E=null,v=null,o.__wbindgen_start(),o}function Be(t){if(o!==void 0)return o;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module:t}=t:console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const e=G();t instanceof WebAssembly.Module||(t=new WebAssembly.Module(t));const n=new WebAssembly.Instance(t,e);return K(n,t)}async function O(t){if(o!==void 0)return o;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL(""+new URL("threegis_core_wasm_bg-Sqjzl7fT.wasm",import.meta.url).href,import.meta.url));const e=G();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await Pe(await t,e);return K(n,r)}var qe=Object.freeze({__proto__:null,TerrainSample:Ce,add:xe,add_feature_data_js:ge,add_process_feature_data_js:we,buffer_line_string:ve,buffer_line_string_direct:Ae,buffer_line_strings_batch:je,cancel_operation:ze,cleanup_cancellation_token:Oe,clear_caches:ue,clear_feature_data_for_bbox_js:be,clear_process_cache_js:pe,create_cancellation_token:Fe,create_terrain_geometry:re,default:O,extract_features_from_vector_tiles:se,extrude_geometry:Q,fetch_vector_tiles:ce,free_cache_by_id:Re,free_cache_group:Ee,free_group_js:Le,generate_3mf_content_types_xml:te,generate_3mf_model_xml:ee,generate_3mf_rels_xml:ne,get_cache_stats:fe,get_cached_process_ids_js:me,get_feature_data_js:de,get_process_feature_data_js:ye,get_wasm_info:Te,has_raster_tile:le,hello_from_rust:he,initSync:Be,merge_geometries_with_csg_union:Me,process_elevation_data_async:oe,process_polygon_geometry:$e,register_cache_group:Se,register_group_js:De,start:_e,store_raster_tile:ae,test_initialization:Ie});const Je=t=>{const e=t.split("/");let n=0,r=0,s=0;if(e.length>=3){const c=parseInt(e[e.length-3],10),_=parseInt(e[e.length-2],10),i=parseInt(e[e.length-1],10);if(isNaN(c)||(s=c),isNaN(_)||(n=_),!isNaN(i)){const u=e[e.length-1],W=u.indexOf(".");W>0?r=parseInt(u.substring(0,W),10):r=i}}return{x:n,y:r,z:s}},He=async(t,e)=>{const n=new AbortController,r=setTimeout(()=>n.abort(),e);try{const s=await fetch(t,{signal:n.signal});return clearTimeout(r),s}catch(s){throw clearTimeout(r),s instanceof Error&&s.name==="AbortError"?new Error(`Request timeout after ${e}ms`):s}},q=async(t,e)=>{let n;for(let r=0;r<=e.maxRetries;r++)try{const s=await He(t,e.timeoutMs);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const c=s.headers.get("content-type")||"application/octet-stream",_=await s.arrayBuffer(),i=new Uint8Array(_);if(e.validateContent&&i.length===0)throw new Error("Empty response data");const u=Je(t);return{width:256,height:256,x:u.x,y:u.y,z:u.z,rawData:i,mimeType:c}}catch(s){if(n=s instanceof Error?s:new Error(String(s)),r<e.maxRetries){const c=e.backoffMs*Math.pow(2,r);await new Promise(_=>setTimeout(_,c));continue}}throw new Error(`Fetch failed after ${e.maxRetries+1} attempts: ${n.message}`)},Ge=()=>{const t={maxRetries:3,timeoutMs:1e4,backoffMs:1e3,validateContent:!0};self.wasmJsHelpers={...self.wasmJsHelpers,fetch:async(e,n)=>{const r={...t,...n};return q(e,r)},fetchWithConfig:async(e,n)=>q(e,n)}};let f=null,j=!1,w=null,h=!1,$=new Map,J=null,D=null;async function Ke(){try{if(console.log("[Worker] Initializing WASM module..."),Ge(),console.log("[Worker] WASM fetch helpers initialized"),!WebAssembly)throw new Error("WebAssembly not supported in worker environment");const t=new WebAssembly.Memory({initial:1024,maximum:8192}),e=new WebAssembly.Table({initial:5e3,maximum:25e3,element:"anyfunc"}),n=new WebAssembly.Table({initial:5e3,maximum:25e3,element:"externref"});self.__WASM_MEMORY=t,self.__WASM_TABLE=e,self.__WASM_EXTERNREF_TABLE=n,self.__wbindgen_externref_table_ptr=n,self.__wbindgen_anyfunc_table_ptr=e,await O(),f=qe;const s=["extract_features_from_vector_tiles","process_polygon_geometry"].filter(c=>!f[c]||typeof f[c]!="function");if(s.length>0)throw new Error(`Missing WASM functions: ${s.join(", ")}`);j=!0,console.log("[Worker] WASM module initialized successfully")}catch(t){throw j=!1,f=null,new Error(`Worker WASM initialization failed: ${t}`)}}async function Ve(t){try{console.log(`[Worker] Syncing shared resources for process: ${t.processId}`),D=t.processId,$.clear(),J=null;for(const e of t.vectorTiles)$.set(e.tileKey,e);t.elevationData&&(J=t.elevationData),j&&f&&await Xe(t),console.log(`[Worker] Successfully synced ${t.vectorTiles.length} vector tiles`)}catch(e){throw console.error("[Worker] Failed to sync shared resources:",e),e}}async function Xe(t){if(!f)throw new Error("WASM module not available");try{if(f.add_process_feature_data_js&&t.vectorTiles.length>0){console.log(`[Worker] Loading ${t.vectorTiles.length} vector tiles into WASM process cache`);const e=t.vectorTiles.map(r=>({tileKey:r.tileKey,x:r.metadata.x,y:r.metadata.y,z:r.metadata.z,sourceLayer:r.metadata.sourceLayer,data:Array.from(new Uint8Array(r.data)),size:r.metadata.size})),n=["vector_tiles","vt_data","tile_cache"];for(const r of n)try{f.add_process_feature_data_js(t.processId,r,JSON.stringify(e))&&console.log(`[Worker] ✅ Successfully stored vector tiles under key: ${r}`)}catch(s){console.warn(`[Worker] Failed to store tiles under key ${r}:`,s)}for(const r of t.vectorTiles)try{const s={x:r.metadata.x,y:r.metadata.y,z:r.metadata.z,sourceLayer:r.metadata.sourceLayer,data:Array.from(new Uint8Array(r.data)),size:r.metadata.size};f.add_process_feature_data_js(t.processId,`tile_${r.tileKey}`,JSON.stringify(s))}catch(s){console.warn(`[Worker] Failed to store individual tile ${r.tileKey}:`,s)}}if(t.elevationData&&f.add_process_feature_data_js)try{f.add_process_feature_data_js(t.processId,"elevation_data",JSON.stringify(t.elevationData))&&console.log("[Worker] ✅ Successfully stored elevation data")}catch(e){console.warn("[Worker] Failed to store elevation data:",e)}console.log(`[Worker] Successfully loaded resources into WASM instance for process ${t.processId}`)}catch(e){console.warn("[Worker] Warning: Could not load resources into WASM:",e)}}async function Ye(t,e){if(!f)throw new Error("WASM module not available");try{if($.size>0){console.log(`[Worker] Using ${$.size} shared vector tiles for process ${t}`);return}if(f.get_cached_process_ids_js){const u=f.get_cached_process_ids_js();if(u&&u.includes(t)){console.log(`[Worker] Vector tiles already available in WASM cache for process ${t}`);return}}const n=`${t}_worker_${Date.now()}_${Math.random().toString(36).substr(2,6)}`;console.log(`[Worker] Fetching vector tiles directly with worker process ID: ${n}`);const[r,s,c,_]=e,i={min_lng:r,min_lat:s,max_lng:c,max_lat:_,zoom:14,grid_width:256,grid_height:256,process_id:n};f.fetch_vector_tiles?(await f.fetch_vector_tiles(i),console.log(`[Worker] ✅ Successfully fetched vector tiles for worker process ${n}`),D=n):console.warn("[Worker] fetch_vector_tiles function not available")}catch(n){console.warn(`[Worker] Warning: Could not ensure vector tiles for process ${t}:`,n)}}async function Ze(t){if(!j||!f)throw new Error("WASM module not initialized in worker");const{layerConfig:e,bboxCoords:n,processId:r,terrainData:s,terrainSettings:c,debugMode:_}=t;try{if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:5,data:{message:`Ensuring vector tiles for ${e.sourceLayer}...`}}),await Ye(r,n),postMessage({id:w,type:"progress",progress:10,data:{message:`Extracting features for ${e.sourceLayer}...`}});const i=D||r,u=await f.extract_features_from_vector_tiles({bbox:n,vtDataSet:e,processId:i,elevationProcessId:i});if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:40,data:{message:`Creating geometry for ${e.sourceLayer}...`}});const W={terrainBaseHeight:c.baseHeight,verticalExaggeration:c.verticalExaggeration,bbox:n,elevationGrid:s.processedElevationGrid,gridSize:s.gridSize,minElevation:s.originalMinElevation,maxElevation:s.originalMaxElevation,vtDataSet:{...e,geometryDebugMode:_},useSameZOffset:!0,processId:i};if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:60,data:{message:`Processing ${e.sourceLayer} geometry...`}});const F=JSON.stringify(W),L=await f.process_polygon_geometry(F);if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:80,data:{message:`Parsing geometry data for ${e.sourceLayer}...`}});let T;try{T=JSON.parse(L)}catch(m){throw new Error(`Failed to parse geometry JSON: ${m}`)}if(h)throw new Error("Task was cancelled");postMessage({id:w,type:"progress",progress:90,data:{message:`Optimizing geometry for ${e.sourceLayer}...`}});const A=[],Qe=T.length;for(let m=0;m<T.length;m++){if(h)throw new Error("Task was cancelled");const b=T[m];if(!b.hasData||!b.vertices||b.vertices.length===0){A.push({hasData:!1,vertices:[],indices:[],normals:[],colors:[],properties:b.properties||{}});continue}const V=new Float32Array(b.vertices);let R=null;b.indices&&b.indices.length>0&&(R=new Uint32Array(b.indices));let U=null,N=!1;b.normals&&b.normals.length>0?U=new Float32Array(b.normals):N=!0;let C=null;b.colors&&b.colors.length>0&&(C=new Float32Array(b.colors)),A.push({hasData:!0,vertices:V,indices:R,normals:U,colors:C,needsNormals:N,properties:b.properties||{}}),m%10===0&&await new Promise(X=>setTimeout(X,0))}return postMessage({id:w,type:"progress",progress:100,data:{message:`${e.sourceLayer} processing complete`}}),{layerConfig:e,geometries:A,totalProcessed:A.length,hasData:A.some(m=>m.hasData)}}catch(i){throw console.error("[Worker] Layer processing failed:",i),i}}self.onmessage=async t=>{const{id:e,type:n,data:r}=t.data;try{switch(n){case"init":await Ke(),postMessage({id:e,type:"initialized",data:{success:!0}});break;case"process-layer":w=e,h=!1;const s=await Ze(r);postMessage({id:e,type:"result",data:s}),w=null;break;case"sync-resources":await Ve(r),postMessage({id:e,type:"resources-synced",success:!0,processId:r.processId});break;case"cancel":(w===e||!e)&&(h=!0,console.log(`[Worker] Cancelling task: ${w||"all"}`));break;case"terminate":if(f&&f.clear_process_cache_js)try{f.clear_process_cache_js()}catch(c){console.warn("[Worker] Cleanup error:",c)}f=null,j=!1,self.close();break;default:throw new Error(`Unknown message type: ${n}`)}}catch(s){console.error("[Worker] Error handling message:",s),postMessage({id:e,type:"error",error:s instanceof Error?s.message:String(s)})}};self.onerror=t=>{console.error("[Worker] Unhandled error:",t),w&&postMessage({id:w,type:"error",error:`Worker error: ${t.message||t}`})};
